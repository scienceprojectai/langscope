name: LangScope Auto-Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_LOGIN_SERVER }}

      # --- BACKEND (ALGORITHM) ---
      - name: Build & Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./Algorithm
          push: true
          tags: ${{ secrets.ACR_LOGIN_SERVER }}/backend:${{ github.sha }}

      - name: Deploy Backend API
        uses: azure/container-apps-deploy-action@v1
        with:
          containerAppName: langscope-api
          resourceGroup: LangScopeRG
          containerAppEnvironment: LangScopeEnv
          imageToDeploy: ${{ secrets.ACR_LOGIN_SERVER }}/backend:${{ github.sha }}
          targetPort: 8000
          ingress: external
          environmentVariables: >-
            MONGO_URI=${{ secrets.MONGO_URI }}
            AZURE_STORAGE_CONN_STR=${{ secrets.AZURE_STORAGE_CONN }}
            NO_AUTH_MODE=true

      # --- FRONTEND (UI) ---
      - name: Build & Push Frontend
        run: |
          az acr build --registry ${{ secrets.ACR_LOGIN_SERVER }} \
            --image frontend:${{ github.sha }} \
            --build-arg VITE_API_BASE_URL="${{ secrets.BACKEND_API_URL }}" \
            --build-arg VITE_SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}" \
            --build-arg VITE_SUPABASE_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            ./frontend

      - name: Deploy Frontend UI (Direct CLI)
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az config set extension.use_dynamic_install=yes_without_prompt
            
            # 1. Extract the ACR name (removes the .azurecr.io part)
            ACR_NAME=$(echo "${{ secrets.ACR_LOGIN_SERVER }}" | cut -d'.' -f1)
            
            # 2. Ensure Admin User is enabled on your registry
            az acr update --name $ACR_NAME --admin-enabled true
            
            # 3. Fetch the registry username and password dynamically
            ACR_USERNAME=$(az acr credential show --name $ACR_NAME --query "username" -o tsv)
            ACR_PASSWORD=$(az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv)
            
            # 4. Create the app and explicitly pass the registry credentials
            az containerapp create \
              --name langscope-ui \
              --resource-group LangScopeRG \
              --environment LangScopeEnv \
              --image ${{ secrets.ACR_LOGIN_SERVER }}/frontend:${{ github.sha }} \
              --target-port 80 \
              --ingress external \
              --min-replicas 1 \
              --max-replicas 1 \
              --registry-server ${{ secrets.ACR_LOGIN_SERVER }} \
              --registry-username $ACR_USERNAME \
              --registry-password $ACR_PASSWORD